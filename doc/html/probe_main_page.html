<!-- HTML header for doxygen 1.8.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="https://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<title>CDI SDK: Connection Probe Architecture</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="image_left.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">CDI SDK
   </div>
   <div id="projectbrief">SDK for transporting chunks of data reliably and with low latency using a polled mode network driver.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Connection Probe Architecture </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#probe_overview">Architecture Overview</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="probe_overview"></a>
Architecture Overview</h1>
<p>In order to establish an SRD connection between two EC2 instances using EFA adapters, a specific sequence of events must occur. The EC2 instance used as a transmitter must obtain an EFA device identifier of the remote EC2 instance in order to establish the connection. Initial startup and optimization of the SRD network flows need to be establish before the connection can be used by the application. For this, a socket based interface is used to control communication. The specific steps used are described below:</p>
<ol type="1">
<li>Create the socket based control interface. The instances start in <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afab57e41bee486c77d18c450cd499f574b">kProbeStateSendReset</a>.</li>
<li>Receiver sends reset requests to transmitter until a reset request is received. All requests contain the EFA device identifier of the sender.</li>
<li>Once the receiver has received the reset request, it advances to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afae2935cc6d803e291dc0ee610456332d7" title="Send a request to reset the connection to the Endpoint Manager and advance to the kProbeStateSendRese...">kProbeStateEfaReset</a> and the Endpoint Manager is used to reset the local connection. While this is occuring, the state is set to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa7334a382eded33e511a23c4743e4c6ff">kProbeStateResetting</a>. When complete, the state is set to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa86f25f17ae210dab0b9de6ebabc928d7">kProbeStateResetDone</a>, which causes the ACK to be sent back to the transmitter. State then advances to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa1d26bfd9479671bd8fbd876f4d4673f8">kProbeStateEfaProbe</a>. This state is used to transmit several SRD packets over the EFA interface to establish the initial network flows.</li>
<li>Once the transmitter has received the ACK for a reset request, it uses the Endpoint Manager to prepare the connection to be started. While this is occuring, the state is set to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa2e368bcefadfca589571f57f838b07ee">kProbeStateWaitForStart</a>. When complete, the state is set to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa284f1421e459f43f938b687c8887c1fb">kProbeStateEfaStart</a>, which causes the connection to be started and begins transmitting SRD packets over the EFA interface. State is set to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa1d26bfd9479671bd8fbd876f4d4673f8">kProbeStateEfaProbe</a>.</li>
<li>After the desired number of SRD probe packets have been successfully transmitted and confirmed as being received by the receiver, the receiver will advance to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa85057fe072457bd73c728b73e69d9ad3">kProbeStateEfaConnected</a>, call the user registered callback function <a class="el" href="cdi__core__api_8h.html#a5ad508526ac5a4696c9816597664bac4" title="Prototype of connection callback function. The user code must implement a function with this prototyp...">CdiCoreConnectionCallback()</a>, and send <a class="el" href="adapter__efa__probe_8h.html#aa548bed9cef20b3d1b13193db9add047a935cbe9d2892b04c66bd17439c42417a" title="Notification that connection has been established (probe has completed). ">kProbeCommandConnected</a> to the transmitter. After the transmitter receives the command, it advances the state to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa85057fe072457bd73c728b73e69d9ad3">kProbeStateEfaConnected</a> and the user registered callback function <a class="el" href="cdi__core__api_8h.html#a5ad508526ac5a4696c9816597664bac4" title="Prototype of connection callback function. The user code must implement a function with this prototyp...">CdiCoreConnectionCallback()</a> is invoked.</li>
<li>While connected, the transmitter will send <a class="el" href="adapter__efa__probe_8h.html#aa548bed9cef20b3d1b13193db9add047a3514f095b18a18970932ae0c161d0a6d" title="Request to ping the connection. ">kProbeCommandPing</a> commands using the control interface to the receiver to ensure both transmitter and receiver are operating correctly. This is done at a regular interval (<a class="el" href="configuration_8h.html#a8ebbc64bfbfcd914e18805c72fdf67d3" title="Once a connection has been established, this defines how often the transmitter sends a ping to comman...">SEND_PING_COMMAND_FREQUENCY_MSEC</a>). If the transmitter does not receive an ACK back within a timeout period (<a class="el" href="configuration_8h.html#a7096e520a92c7acc07175018f2eab349" title="This value is used by the transmitter to define how long it waits for an ACK response to a ping comma...">TX_PING_ACK_TIMEOUT_MSEC</a>), a few more attempts are made. If these attempts fail, the transmitter disables the EFA connection and returns to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afab57e41bee486c77d18c450cd499f574b">kProbeStateSendReset</a> state.</li>
</ol>
<p>NOTE: The user registered callback function <a class="el" href="cdi__core__api_8h.html#a5ad508526ac5a4696c9816597664bac4" title="Prototype of connection callback function. The user code must implement a function with this prototyp...">CdiCoreConnectionCallback()</a> is invoked whenever the connection state changes (<a class="el" href="cdi__core__api_8h.html#a46b31bc48caec610070097d7e181a5bfae4b54a7bca3be5845816f264d3b082a1" title="Connected and ready for use. ">kCdiConnectionStatusConnected</a> or <a class="el" href="cdi__core__api_8h.html#a46b31bc48caec610070097d7e181a5bfa411c891aa005c2309d03d604093bd2e8" title="Disconnected. The SDK is trying to establish the connection. ">kCdiConnectionStatusDisconnected</a>).</p>
<p>The diagram shown below provides an overview of the connection probe architecture. </p><div class="image">
<img src="probe_high_level_architecture.jpg" alt="probe_high_level_architecture.jpg"/>
</div>
 </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
	<div>Copyright Amazon.com Inc. or its affiliates. All Rights Reserved.</div>
</small></address>
</body>
</html>
